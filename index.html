<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±è¯­å£è¯­ç»ƒä¹ æ‰“å¡ç³»ç»Ÿ - ç®€æ˜“ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #74ebd5 0%, #9face6 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        header {
            background: #4a6ee0;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        .login-section {
            padding: 30px;
            text-align: center;
        }
        
        .role-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .role-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .teacher-btn {
            background: #ff6b6b;
            color: white;
        }
        
        .student-btn {
            background: #4ecdc4;
            color: white;
        }
        
        .role-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .content-section {
            display: none;
            padding: 20px;
        }
        
        .teacher-panel, .student-panel {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 10px 0;
        }
        
        textarea, input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        button {
            background: #4a6ee0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        .exercise-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #4a6ee0;
        }
        
        .result {
            background: #e7f3ff;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            display: none;
        }
        
        .score {
            font-size: 24px;
            font-weight: bold;
            color: #4a6ee0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>è‹±è¯­å£è¯­ç»ƒä¹ æ‰“å¡ç³»ç»Ÿ</h1>
            <p>ç®€æ˜“ç‰ˆ - ä¸“ä¸ºå°ç™½è®¾è®¡</p>
        </header>
        
        <div class="login-section" id="loginSection">
            <h2>è¯·é€‰æ‹©æ‚¨çš„èº«ä»½</h2>
            <div class="role-buttons">
                <button class="role-btn teacher-btn" onclick="login('teacher')">ğŸ‘¨â€ğŸ« æˆ‘æ˜¯æ•™å¸ˆ</button>
                <button class="role-btn student-btn" onclick="login('student')">ğŸ‘¨â€ğŸ“ æˆ‘æ˜¯å­¦ç”Ÿ</button>
            </div>
            <p>é€‰æ‹©èº«ä»½åå¼€å§‹ä½¿ç”¨ç³»ç»Ÿ</p>
        </div>
        
        <div class="content-section" id="teacherSection">
            <h2>æ•™å¸ˆç®¡ç†é¢æ¿</h2>
            
            <div class="teacher-panel">
                <h3>å‘å¸ƒæ–°ç»ƒä¹ </h3>
                <input type="text" id="exerciseTitle" placeholder="ç»ƒä¹ æ ‡é¢˜">
                <textarea id="exerciseContent" placeholder="ç»ƒä¹ å†…å®¹ï¼Œä¾‹å¦‚ï¼šPlease introduce yourself in English."></textarea>
                <button onclick="publishExercise()">å‘å¸ƒç»ƒä¹ </button>
            </div>
            
            <div class="teacher-panel">
                <h3>å­¦ç”Ÿæ‰“å¡ç»Ÿè®¡</h3>
                <div id="statistics">
                    <p>æš‚æ— æ•°æ®ï¼Œç­‰å¾…å­¦ç”Ÿæ‰“å¡...</p>
                </div>
            </div>
        </div>
        
        <div class="content-section" id="studentSection">
            <h2>å­¦ç”Ÿç»ƒä¹ é¢æ¿</h2>
            
            <div class="student-panel">
                <h3>ä»Šæ—¥ç»ƒä¹ </h3>
                <div id="currentExercise">
                    <p>æš‚æ— ç»ƒä¹ ï¼Œç­‰å¾…è€å¸ˆå‘å¸ƒ...</p>
                </div>
                
                <button onclick="startRecording()">ğŸ¤ å¼€å§‹å½•éŸ³</button>
                <button onclick="stopRecording()" disabled>â¹ï¸ åœæ­¢å½•éŸ³</button>
                <button onclick="submitExercise()" disabled>ğŸ“¤ æäº¤ç»ƒä¹ </button>
                
                <div class="result" id="result">
                    <h3>è¯„æµ‹ç»“æœ</h3>
                    <div class="score">å¾—åˆ†: <span id="score">0</span>åˆ†</div>
                    <p>å‡†ç¡®åº¦: <span id="accuracy">0</span>%</p>
                    <p>æµåˆ©åº¦: <span id="fluency">0</span>%</p>
                    <p>åé¦ˆ: <span id="feedback">æš‚æ— </span></p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;
        let audioBlob;
        
        // è¿™é‡Œæ˜¯ç®€å•çš„JavaScriptä»£ç ï¼Œå®ç°åŸºæœ¬åŠŸèƒ½
        function login(role) {
            document.getElementById('loginSection').style.display = 'none';
            
            if (role === 'teacher') {
                document.getElementById('teacherSection').style.display = 'block';
                loadTeacherData();
            } else {
                document.getElementById('studentSection').style.display = 'block';
                loadStudentData();
            }
        }
        
        function publishExercise() {
            const title = document.getElementById('exerciseTitle').value;
            const content = document.getElementById('exerciseContent').value;
            
            if (!title || !content) {
                alert('è¯·å¡«å†™å®Œæ•´çš„ç»ƒä¹ ä¿¡æ¯ï¼');
                return;
            }
            
            // è¿™é‡Œåº”è¯¥æ˜¯ä¿å­˜åˆ°æœåŠ¡å™¨çš„ä»£ç 
            // ä½†ç®€æ˜“ç‰ˆæˆ‘ä»¬å…ˆä¿å­˜åœ¨æœ¬åœ°
            localStorage.setItem('currentExercise', JSON.stringify({
                title: title,
                content: content,
                date: new Date().toLocaleDateString()
            }));
            
            alert('ç»ƒä¹ å‘å¸ƒæˆåŠŸï¼');
            document.getElementById('exerciseTitle').value = '';
            document.getElementById('exerciseContent').value = '';
        }
        
        function loadTeacherData() {
            // åŠ è½½æ•™å¸ˆæ•°æ®
            const exercise = localStorage.getItem('currentExercise');
            if (exercise) {
                const exData = JSON.parse(exercise);
                document.getElementById('statistics').innerHTML = `
                    <p><strong>å½“å‰ç»ƒä¹ :</strong> ${exData.title}</p>
                    <p><strong>å‘å¸ƒæ—¶é—´:</strong> ${exData.date}</p>
                    <p><strong>å®Œæˆäººæ•°:</strong> <span id="completeCount">0</span>äºº</p>
                `;
            }
        }
        
        function loadStudentData() {
            // åŠ è½½å­¦ç”Ÿæ•°æ®
            const exercise = localStorage.getItem('currentExercise');
            if (exercise) {
                const exData = JSON.parse(exercise);
                document.getElementById('currentExercise').innerHTML = `
                    <h4>${exData.title}</h4>
                    <p>${exData.content}</p>
                    <p><small>å‘å¸ƒæ—¶é—´: ${exData.date}</small></p>
                `;
            }
        }
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                };
                
                mediaRecorder.start();
                isRecording = true;
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelector('button[onclick="startRecording()"]').disabled = true;
                document.querySelector('button[onclick="stopRecording()"]').disabled = false;
                document.querySelector('button[onclick="submitExercise()"]').disabled = true;
                
                // æ˜¾ç¤ºå½•éŸ³çŠ¶æ€
                const recordBtn = document.querySelector('button[onclick="stopRecording()"]');
                const originalText = recordBtn.textContent;
                recordBtn.textContent = 'ğŸ”´ å½•éŸ³ä¸­...';
                
                // æ›´æ–°å½•éŸ³çŠ¶æ€æ˜¾ç¤º
                let recordingTime = 0;
                const recordingInterval = setInterval(() => {
                    if (!isRecording) {
                        clearInterval(recordingInterval);
                        recordBtn.textContent = originalText;
                    } else {
                        recordingTime++;
                        const minutes = Math.floor(recordingTime / 60);
                        const seconds = recordingTime % 60;
                        recordBtn.textContent = `ğŸ”´ å½•éŸ³ä¸­... ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
                
                console.log('å½•éŸ³å¼€å§‹...');
            } catch (error) {
                console.error('æ— æ³•è®¿é—®éº¦å…‹é£:', error);
                alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼Œè¯·æ£€æŸ¥æƒé™è®¾ç½®');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                // åœæ­¢æ‰€æœ‰éŸ³è½¨
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelector('button[onclick="startRecording()"]').disabled = false;
                document.querySelector('button[onclick="stopRecording()"]').disabled = true;
                document.querySelector('button[onclick="submitExercise()"]').disabled = false;
                
                console.log('å½•éŸ³ç»“æŸï¼Œå¯ä»¥æäº¤è¯„æµ‹');
            }
        }
        
        async function submitExercise() {
            if (!audioBlob) {
                alert('è¯·å…ˆå½•éŸ³å†æäº¤ï¼');
                return;
            }
            
            // è·å–ç»ƒä¹ å†…å®¹
            const exercise = localStorage.getItem('currentExercise');
            if (!exercise) {
                alert('æ²¡æœ‰å¯è¯„æµ‹çš„ç»ƒä¹ å†…å®¹ï¼');
                return;
            }
            
            const exData = JSON.parse(exercise);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const submitBtn = document.querySelector('button[onclick="submitExercise()"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'â³ è¯„æµ‹ä¸­...';
            submitBtn.disabled = true;
            
            try {
                // å°†éŸ³é¢‘è½¬æ¢ä¸ºbase64
                const audioBase64 = await blobToBase64(audioBlob);
                
                // è°ƒç”¨åç«¯APIè¿›è¡Œè¯„æµ‹
                const response = await fetch('/api/evaluate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        audioData: audioBase64,
                        text: exData.content,
                        sessionId: generateSessionId()
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    // æ˜¾ç¤ºçœŸå®çš„è¯„æµ‹ç»“æœ
                    displayEvaluationResult(result);
                    
                    // æ›´æ–°ç»Ÿè®¡
                    const completeCount = parseInt(localStorage.getItem('completeCount') || '0') + 1;
                    localStorage.setItem('completeCount', completeCount.toString());
                    
                } else {
                    throw new Error(result.error || 'è¯„æµ‹å¤±è´¥');
                }
                
            } catch (error) {
                console.error('è¯„æµ‹å¤±è´¥:', error);
                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œæ˜¾ç¤ºæ¨¡æ‹Ÿç»“æœ
                displayMockResult();
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }
        
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }
        
        function displayEvaluationResult(result) {
            document.getElementById('score').textContent = result.score || 0;
            document.getElementById('accuracy').textContent = result.accuracy || 0;
            document.getElementById('fluency').textContent = result.fluency || 0;
            document.getElementById('feedback').textContent = result.feedback || 'è¯„æµ‹å®Œæˆ';
            document.getElementById('result').style.display = 'block';
        }
        
        function displayMockResult() {
            // æ¨¡æ‹Ÿè¯„æµ‹ç»“æœ
            const score = Math.floor(Math.random() * 30) + 70; // 70-100åˆ†
            const accuracy = Math.floor(Math.random() * 20) + 80; // 80-100%
            const fluency = Math.floor(Math.random() * 20) + 80; // 80-100%
            
            document.getElementById('score').textContent = score;
            document.getElementById('accuracy').textContent = accuracy;
            document.getElementById('fluency').textContent = fluency;
            document.getElementById('feedback').textContent = 'ä½¿ç”¨æ¨¡æ‹Ÿè¯„æµ‹ç»“æœ';
            document.getElementById('result').style.display = 'block';
            
            // æ›´æ–°ç»Ÿè®¡
            const completeCount = parseInt(localStorage.getItem('completeCount') || '0') + 1;
            localStorage.setItem('completeCount', completeCount.toString());
            
            alert('ç»ƒä¹ æäº¤æˆåŠŸï¼ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿè¯„æµ‹ç»“æœï¼‰');
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ç°æœ‰ç»ƒä¹ 
            const exercise = localStorage.getItem('currentExercise');
            if (exercise) {
                loadTeacherData();
            }
            
            // æ£€æŸ¥æµè§ˆå™¨æ˜¯å¦æ”¯æŒå½•éŸ³
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                console.warn('æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å½•åˆ¶åŠŸèƒ½');
                alert('æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å½•åˆ¶åŠŸèƒ½ï¼Œè¯·ä½¿ç”¨ç°ä»£æµè§ˆå™¨');
            }
        };
    </script>
</body>
</html>